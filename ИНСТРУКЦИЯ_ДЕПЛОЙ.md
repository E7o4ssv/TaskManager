# Деплой FerretTask на сервер 91.229.11.58

Сервер: **91.229.11.58**  
Пароль для входа: у вас есть (используйте при `ssh root@91.229.11.58`).

После настройки при пуше в ветку **main** приложение будет автоматически обновляться на сервере.

---

## Часть 1. Один раз настроить сервер

### 1.1. Подключиться к серверу

На своём компьютере:

```bash
ssh root@91.229.11.58
```

Введите пароль, когда попросит.

### 1.2. Скачать и запустить скрипт настройки

**Вариант А** — скрипт уже в main. На сервере (после входа):

```bash
curl -sSL https://raw.githubusercontent.com/E7o4ssv/TaskManager/main/scripts/setup-server.sh -o /tmp/setup.sh
chmod +x /tmp/setup.sh
/tmp/setup.sh
```

**Вариант Б** — скрипт ещё не запушен. На своём компьютере из папки проекта:

```bash
scp scripts/setup-server.sh root@91.229.11.58:/tmp/setup.sh
ssh root@91.229.11.58
# на сервере:
chmod +x /tmp/setup.sh
/tmp/setup.sh
```

Если репозиторий приватный или что-то пойдёт не так, выполните шаги вручную (см. раздел «Ручная настройка» ниже).

Скрипт попросит добавить Deploy key в GitHub:

1. Откройте: https://github.com/E7o4ssv/TaskManager/settings/keys  
2. **Add deploy key** → вставьте ключ, который вывел скрипт на сервере (одна длинная строка из `id_ed25519_github.pub`).  
3. Поставьте галочку **Allow write access** не обязательно (достаточно read-only).  
4. На сервере нажмите Enter и дождитесь окончания установки.

После выполнения скрипта приложение будет доступно по адресу: **http://91.229.11.58:3000**

### 1.3. (Опционально) Запустить seed для первых пользователей

На сервере:

```bash
cd /var/www/ferrettask
npm run db:seed
```

Выйти с сервера: `exit`.

---

## Часть 2. Настроить автодеплой при push в main

Чтобы при каждом `git push origin main` приложение на сервере обновлялось автоматически, нужны секреты в GitHub.

### 2.1. Ключ для входа на сервер

На **своём компьютере** должен быть ключ, которым GitHub Actions будет подключаться к серверу. Варианты:

- Использовать существующий ключ из `danywhite/.deploy-keys/id_ed25519` (его **публичную** часть нужно добавить на сервер в `authorized_keys`).
- Или сгенерировать новый ключ только для деплоя (см. ниже).

**Добавить публичный ключ на сервер:**

На своём компьютере (подставьте путь к своему `.pub`):

```bash
ssh-copy-id -i .deploy-keys/id_ed25519.pub root@91.229.11.58
```

Введите пароль сервера один раз. После этого вход по ключу будет без пароля, и его же можно использовать для GitHub Actions.

### 2.2. Секреты в репозитории GitHub

1. Откройте: https://github.com/E7o4ssv/TaskManager/settings/secrets/actions  
2. Нажмите **New repository secret** и создайте три секрета:

| Имя              | Значение |
|------------------|----------|
| `SERVER_HOST`    | `91.229.11.58` |
| `SERVER_USER`    | `root` |
| `SSH_PRIVATE_KEY` | Весь текст **приватного** ключа (файл без `.pub`), от `-----BEGIN` до `-----END ...` включительно. |

Для `SSH_PRIVATE_KEY` подойдёт содержимое файла `.deploy-keys/id_ed25519` (тот же ключ, который вы добавили на сервер через `ssh-copy-id`).

---

## Готово

- Приложение: **http://91.229.11.58:3000**
- После любого `git push origin main` во вкладке **Actions** репозитория запустится workflow и обновит приложение на сервере.

---

## Ручная настройка сервера (если скрипт не подошёл)

Подключитесь: `ssh root@91.229.11.58`, затем по шагам:

```bash
# Node 20 и PM2
apt-get update && apt-get install -y curl git
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt-get install -y nodejs
npm install -g pm2

# Ключ для GitHub (добавьте его в Deploy keys репозитория)
mkdir -p /root/.ssh && chmod 700 /root/.ssh
ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519_github -N "" -C "server-deploy"
cat /root/.ssh/id_ed25519_github.pub
# Скопируйте вывод и добавьте в GitHub -> Repo -> Settings -> Deploy keys

ssh-keyscan -H github.com >> /root/.ssh/known_hosts
git clone git@github.com:E7o4ssv/TaskManager.git /var/www/ferrettask
cd /var/www/ferrettask

# .env
echo 'DATABASE_URL="file:./prod.db"' > .env
echo 'NEXT_PUBLIC_APP_URL="http://91.229.11.58:3000"' >> .env

# Сборка и запуск
npm ci
npx prisma generate
npx prisma db push
npm run build
pm2 start npm --name ferrettask -- start
pm2 save
pm2 startup
```

После этого настройте секреты в GitHub (часть 2 выше) для автодеплоя.
